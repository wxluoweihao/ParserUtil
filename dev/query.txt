SELECT
    GROUP_KEY AS GROUP_KEY,
    COUNT(MESSAGE_A) AS CNT1,
    COUNT(MESSAGE_B) AS CNT2,
    ROW_NUMBER() OVER(PARTITION BY GROUP_KEY ORDER BY COUNT(MESSAGE_A)) AS RN
FROM (
    SELECT CAST('KEY' AS VARCHAR) AS GROUP_KEY, A.MESSAGE AS MESSAGE_A, B.MESSAGE AS MESSAGE_B
    FROM HDFS.TEST.EXAMPLE A
    LEFT JOIN (
        SELECT *
        FROM HDFS.TEST.EXAMPLE
    ) B ON A.MESSAGE = B.MESSAGE
) T
WHERE CAST(MESSAGE_A AS VARCHAR) != 'HAHAHAHA' AND CAST(MESSAGE_B AS VARCHAR) = 'TEST'
GROUP BY GROUP_KEY